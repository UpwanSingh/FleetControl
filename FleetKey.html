<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta charset="UTF-8">
    <title>Fleet Control KeyGen</title>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            padding: 20px;
            background: #f0f2f5;
            color: #333;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            margin: 0 auto;
        }

        h2 {
            text-align: center;
            margin-top: 0;
            color: #1a73e8;
        }

        input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            -webkit-appearance: none;
            appearance: none;
        }

        button {
            width: 100%;
            padding: 15px;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            touch-action: manipulation;
            -webkit-appearance: none;
            appearance: none;
        }

        button:active {
            background: #1557b0;
        }

        .result {
            margin-top: 20px;
            padding: 20px;
            background: #e8f0fe;
            border: 2px dashed #1a73e8;
            border-radius: 8px;
            text-align: center;
            display: none;
        }

        .key {
            font-family: monospace;
            font-size: 32px;
            font-weight: bold;
            color: #1a73e8;
            letter-spacing: 4px;
            margin: 10px 0;
            word-break: break-all;
            -webkit-user-select: all;
            user-select: all;
        }

        .label {
            font-size: 12px;
            color: #5f6368;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        #debugLog {
            margin-top: 20px;
            padding: 10px;
            background: #333;
            color: #0f0;
            font-family: monospace;
            font-size: 12px;
            border-radius: 4px;
            white-space: pre-wrap;
            display: none;
        }
        
        .copy-btn {
            background: #34a853 !important;
            color: white !important;
        }
    </style>
</head>

<body>
    <div class="card">
        <h2>üîê License Generator</h2>
        <div class="label">Client Device ID</div>
        <input type="text" id="clientId" placeholder="Paste ID here..." autocorrect="off" autocapitalize="none"
            autocomplete="off" spellcheck="false" />
        <button id="generateBtn">GENERATE KEY</button>
        <div id="resultArea" class="result">
            <div class="label">LICENSE KEY</div>
            <div class="key" id="outputKey"></div>
            <button id="copyBtn" class="copy-btn">üìã TAP TO COPY</button>
        </div>
        <div id="debugLog"></div>
    </div>

    <script>
        // Attach event listeners properly for iOS
        document.getElementById('generateBtn').addEventListener('click', generateKey);
        document.getElementById('generateBtn').addEventListener('touchend', function(e) {
            e.preventDefault();
            generateKey();
        });
        
        document.getElementById('copyBtn').addEventListener('click', copyKey);
        document.getElementById('copyBtn').addEventListener('touchend', function(e) {
            e.preventDefault();
            copyKey();
        });

        // Logger function for mobile debugging
        function log(msg) {
            var debugEl = document.getElementById('debugLog');
            debugEl.style.display = 'block';
            debugEl.innerText += "> " + msg + "\n";
            console.log(msg);
        }

        function generateKey() {
            try {
                log("Starting generation...");
                var inputEl = document.getElementById('clientId');
                var rawId = inputEl.value || '';

                if (!rawId || rawId.trim() === '') {
                    alert("Please enter the Client ID");
                    return;
                }

                log("Raw Input length: " + rawId.length);

                // Aggressive sanitization: Keep ONLY alphanumeric (handles iOS invisible chars)
                var id = '';
                for (var i = 0; i < rawId.length; i++) {
                    var c = rawId.charCodeAt(i);
                    // Only keep 0-9, A-Z, a-z
                    if ((c >= 48 && c <= 57) || (c >= 65 && c <= 90) || (c >= 97 && c <= 122)) {
                        id += rawId.charAt(i);
                    }
                }
                
                log("Sanitized ID: " + id);
                inputEl.value = id;

                if (id.length === 0) {
                    alert("ID contains no valid characters");
                    return;
                }

                // Secret
                var secret = "FLEET_CONTROL_2026_SUPER_SECRET_KEY_99";
                var text = id + secret;
                log("Input prepared. Hashing...");

                // SHA-256
                var hash = sha256(text).toUpperCase();
                log("Hash generated: " + hash.substring(0, 8) + "...");

                // Display
                var finalKey = hash.substring(0, 8);
                document.getElementById('outputKey').innerText = finalKey;
                document.getElementById('resultArea').style.display = 'block';
                log("Done. Key: " + finalKey);

            } catch (e) {
                log("ERROR: " + e.message + " | " + e.stack);
                alert("Error: " + e.message);
            }
        }

        function copyKey() {
            var keyText = document.getElementById('outputKey').innerText;
            if (!keyText) return;

            // Method 1: Modern Clipboard API (works on most browsers)
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(keyText).then(function() {
                    showCopySuccess(keyText);
                }).catch(function() {
                    fallbackCopy(keyText);
                });
            } else {
                fallbackCopy(keyText);
            }
        }
        
        function fallbackCopy(text) {
            // Method 2: Create temporary textarea (works on iOS Safari)
            try {
                var textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.left = '-9999px';
                textarea.style.top = '0';
                textarea.setAttribute('readonly', '');
                document.body.appendChild(textarea);
                
                // iOS specific selection
                var range = document.createRange();
                range.selectNodeContents(textarea);
                var selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                textarea.setSelectionRange(0, 999999);
                
                var success = document.execCommand('copy');
                document.body.removeChild(textarea);
                
                if (success) {
                    showCopySuccess(text);
                } else {
                    // Method 3: Show prompt for manual copy
                    prompt("Copy this key:", text);
                }
            } catch (e) {
                prompt("Copy this key:", text);
            }
        }
        
        function showCopySuccess(text) {
            var btn = document.getElementById('copyBtn');
            var original = btn.innerText;
            btn.innerText = "‚úì COPIED!";
            btn.style.background = "#34a853";
            setTimeout(function() {
                btn.innerText = original;
            }, 2000);
        }

        /**
         * SHA-256 implementation - iOS Safari compatible
         * Using string building instead of charCodeAt on potentially undefined indices
         */
        function sha256(msg) {
            function rotr(n, x) { return (x >>> n) | (x << (32 - n)); }
            function sigma0(x) { return rotr(7, x) ^ rotr(18, x) ^ (x >>> 3); }
            function sigma1(x) { return rotr(17, x) ^ rotr(19, x) ^ (x >>> 10); }
            function Sigma0(x) { return rotr(2, x) ^ rotr(13, x) ^ rotr(22, x); }
            function Sigma1(x) { return rotr(6, x) ^ rotr(11, x) ^ rotr(25, x); }
            function Ch(x, y, z) { return (x & y) ^ (~x & z); }
            function Maj(x, y, z) { return (x & y) ^ (x & z) ^ (y & z); }

            var K = [
                0x428a2f98, 0x71374491, 0xb5c0fbcf, 0xe9b5dba5, 0x3956c25b, 0x59f111f1, 0x923f82a4, 0xab1c5ed5,
                0xd807aa98, 0x12835b01, 0x243185be, 0x550c7dc3, 0x72be5d74, 0x80deb1fe, 0x9bdc06a7, 0xc19bf174,
                0xe49b69c1, 0xefbe4786, 0x0fc19dc6, 0x240ca1cc, 0x2de92c6f, 0x4a7484aa, 0x5cb0a9dc, 0x76f988da,
                0x983e5152, 0xa831c66d, 0xb00327c8, 0xbf597fc7, 0xc6e00bf3, 0xd5a79147, 0x06ca6351, 0x14292967,
                0x27b70a85, 0x2e1b2138, 0x4d2c6dfc, 0x53380d13, 0x650a7354, 0x766a0abb, 0x81c2c92e, 0x92722c85,
                0xa2bfe8a1, 0xa81a664b, 0xc24b8b70, 0xc76c51a3, 0xd192e819, 0xd6990624, 0xf40e3585, 0x106aa070,
                0x19a4c116, 0x1e376c08, 0x2748774c, 0x34b0bcb5, 0x391c0cb3, 0x4ed8aa4a, 0x5b9cca4f, 0x682e6ff3,
                0x748f82ee, 0x78a5636f, 0x84c87814, 0x8cc70208, 0x90befffa, 0xa4506ceb, 0xbef9a3f7, 0xc67178f2
            ];

            var H = [0x6a09e667, 0xbb67ae85, 0x3c6ef372, 0xa54ff53a, 0x510e527f, 0x9b05688c, 0x1f83d9ab, 0x5be0cd19];

            // Convert message to bytes array (safer for iOS)
            var bytes = [];
            for (var i = 0; i < msg.length; i++) {
                var c = msg.charCodeAt(i);
                if (c < 128) {
                    bytes.push(c);
                } else if (c < 2048) {
                    bytes.push((c >> 6) | 192);
                    bytes.push((c & 63) | 128);
                } else {
                    bytes.push((c >> 12) | 224);
                    bytes.push(((c >> 6) & 63) | 128);
                    bytes.push((c & 63) | 128);
                }
            }
            
            // Padding
            var msgLen = bytes.length;
            bytes.push(0x80);
            while ((bytes.length % 64) !== 56) {
                bytes.push(0);
            }
            
            // Append length in bits as 64-bit big-endian
            var bitLen = msgLen * 8;
            for (var i = 7; i >= 0; i--) {
                bytes.push((bitLen / Math.pow(256, i)) & 0xff);
            }

            // Process each 64-byte chunk
            for (var chunk = 0; chunk < bytes.length; chunk += 64) {
                var W = [];
                
                // Build W[0..15] from bytes
                for (var i = 0; i < 16; i++) {
                    var idx = chunk + i * 4;
                    W[i] = (bytes[idx] << 24) | (bytes[idx + 1] << 16) | (bytes[idx + 2] << 8) | bytes[idx + 3];
                }
                
                // Extend W[16..63]
                for (var i = 16; i < 64; i++) {
                    W[i] = (sigma1(W[i - 2]) + W[i - 7] + sigma0(W[i - 15]) + W[i - 16]) >>> 0;
                }

                var a = H[0], b = H[1], c = H[2], d = H[3];
                var e = H[4], f = H[5], g = H[6], h = H[7];

                for (var i = 0; i < 64; i++) {
                    var T1 = (h + Sigma1(e) + Ch(e, f, g) + K[i] + W[i]) >>> 0;
                    var T2 = (Sigma0(a) + Maj(a, b, c)) >>> 0;
                    h = g; g = f; f = e; e = (d + T1) >>> 0;
                    d = c; c = b; b = a; a = (T1 + T2) >>> 0;
                }

                H[0] = (H[0] + a) >>> 0; H[1] = (H[1] + b) >>> 0;
                H[2] = (H[2] + c) >>> 0; H[3] = (H[3] + d) >>> 0;
                H[4] = (H[4] + e) >>> 0; H[5] = (H[5] + f) >>> 0;
                H[6] = (H[6] + g) >>> 0; H[7] = (H[7] + h) >>> 0;
            }

            var hex = "";
            for (var i = 0; i < 8; i++) {
                hex += ("00000000" + H[i].toString(16)).slice(-8);
            }
            return hex;
        }
    </script>
</body>

</html>